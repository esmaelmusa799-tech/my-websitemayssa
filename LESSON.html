<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>الدروس التفاعلية - غرزة الكروشيه</title>
  <style>
    :root {
      --bg: #EAF2F5;
      --container-gradient: linear-gradient(135deg, #F5F5DC 0%, #F6C1CC 50%, #C9E4F6 100%);
      --header-gradient: linear-gradient(90deg,  rgb(240, 240, 209) 50%, rgb(192, 227, 250) 100%);
      --heading: #2F3E46;
      --text: #4A5D63;
      --muted: #6B7C82;
      --primary: #9AD0EC;
      --primary-dark: #7CB8DB;
      --secondary: #F6C1CC;
      --secondary-dark: #F2A7B5;
      --yarn-color: #2F3E46; /* رمادي غامق */

    }
  
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Cairo", "Tahoma", sans-serif;
      background: var(--bg);
      color: var(--text);
      
    }
  
    header {
      background: var(--header-gradient);
      color: var(--heading);
      padding: 14px 16px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      border-bottom: 4px solid rgba(246,193,204,0.4);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    header .title { font-size: 20px; font-weight: 800; }
    header .subtitle { font-size: 13px; color: var(--muted); }
  
    .layout {
      display: grid;
      grid-template-columns: 280px 1fr 420px;
      gap: 16px;
      padding: 16px;
      transition: grid-template-columns 0.25s ease;
    }
    .collapsed .layout { grid-template-columns: 1fr 580px; }
  
    /* ✅ الحاويات الموحدة مع ظل داخلي */
    .card,
    .theory-content,
    .pattern,
    .gallery,
    .controls {
      background: var(--container-gradient);
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08), inset 0 0 12px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
      color: var(--text);
      padding: 12px;
    }
  
    .sidebar-header {
      padding: 12px 16px;
      background: rgba(255,255,255,0.3);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-weight: 700;
      color: var(--heading);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
  
    .lesson-item {
      padding: 12px 16px;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.04s ease;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
    }
    .lesson-item:hover { background: rgba(246,193,204,0.4); }
    .lesson-item.active { background: rgba(201,228,246,0.5); border-right: 4px solid var(--primary); }
    .lesson-name { font-weight: 700; color: var(--heading); }
    .lesson-meta { font-size: 12px; color: var(--muted); }
  
    .stage-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      background: rgba(211, 4, 45, 0.3);
    }
    .stage-title { font-weight: 800; color: var(--heading); }
    .step-indicator {
      font-size: 13px; color: var(--muted);
      background: rgba(255,255,255,0.5); padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);
    }
  
    #stage-container {
      width: 100%;
      height: 420px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--container-gradient);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.08);
    }
    .pattern .row {
  display: flex;
  flex-wrap: wrap;       /* يسمح بتوزيع العناصر على أكثر من سطر */
  gap: 10px;             /* يضيف مسافة موحدة بين كل عنصر */
  margin-bottom: 8px;
}

.chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 14px;     /* زيادة التباعد الداخلي */
  background: var(--pattern-chip-bg);
  border: 1px solid var(--pattern-chip-border);
  color: var(--pattern-chip-text);
  border-radius: 999px;
  font-size: 14px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.08);
}



    .btn {
      border: none;
      background: var(--primary);
      color: #12313b;
      padding: 9px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      transition: transform 0.08s ease, background 0.2s ease;
      font-size: 13px;
    }
    .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn.secondary {
      background: var(--secondary);
      color: #4A5D63;
    }
    .btn.secondary:hover { background: var(--secondary-dark); }
  
    .chip {
      background: var(--secondary);
      border: 1px solid var(--primary);
      color: var(--heading);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.08);
    }
  
    .gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .thumb {
      background: #fff;
      border: 1px solid #C9E4F6;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08), inset 0 0 8px rgba(0,0,0,0.08);
    }
    .thumb img {
      width: 100%; height: 100%; object-fit: cover; display: block;
      transition: transform 0.2s ease;
    }
    .thumb:hover img { transform: scale(1.05); }
  
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal.open { display: flex; }
    .modal-content {
      background: #000; padding: 12px; border-radius: 12px; max-width: 86vw; max-height: 86vh;
      box-shadow: inset 0 0 12px rgba(255,255,255,0.2);
    }
    .modal-content img { max-width: 84vw; max-height: 80vh; display: block; }
  
    @media (max-width: 1120px) {
      .layout { grid-template-columns: 1fr; }
      .collapsed .layout { grid-template-columns: 1fr; }
      #stage-container { height: 360px; }
      .gallery { grid-template-columns: repeat(2, 1fr); }
    }

    /* تنسيق الأزرار */
.nav-buttons {
  display: flex;
  justify-content: center;
  gap: 15px; /* مسافة بين الأزرار */
  margin: 20px 0;
}

.nav-buttons a,
.nav-buttons button {
  background-color: #dcdcdc; /* رمادي فاتح */
  color: #333;              /* نص داكن ليتباين */
  border: none;
  padding: 12px 28px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;    /* إزالة الخط تحت الرابط */
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

/* تأثير عند التحويم */
.nav-buttons a:hover,
.nav-buttons button:hover {
  background-color: #bfbfbf; /* رمادي أغمق قليلاً */
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
}

/* عند الضغط */
.nav-buttons a:active,
.nav-buttons button:active {
  transform: scale(0.97);
}

  </style>
  
</head>
<body>

  <header>
    <div>
      <div class="title">صفحة الدروس التفاعلية</div>
      <div class="subtitle"> </div>
    </div>

    <div class="toolbar">
      <button class="btn secondary" id="toggleSidebar">إخفاء * إظهار الدروس</button>
      <BR>
        <BR>
      <div class="color-wrap">
        <label>خيط</label><input type="color" id="yarnColorPicker" value="#87cefa" />
        <label>غرزة</label><input type="color" id="stitchColorPicker" value="#ff9060" />
      </div>
    </div>

    <div class="subtitle"></div>
    <BR>
      <div class="nav-buttons">
          <a href="INDEX.html" class="btn btn-primary">السابق</a>
          <a href="PROJECT.html" class="btn btn-primary">التالي</a>
        </div>
        
  </header>

  <div class="layout">
    <!-- القائمة الجانبية للدروس -->
    <div class="card" id="sidebarCard">
      <div class="sidebar-header">
        <span>قائمة الدروس (12)</span>
        <span style="font-size:12px;color:#666">انقر لاختيار الدرس</span>
      </div>
      <div class="lessons" id="lessonsList"></div>
    </div>

    <!-- المسرح التفاعلي -->
    <div class="card">
      <div class="stage-header">
        <div class="stage-title" id="lessonTitle">—</div>
        <div class="step-indicator" id="stepIndicator">الخطوة 1 من —</div>
      </div>
      <div id="stage-container"></div>
      <div class="controls">
        <div class="buttons" >  
        <button class="btn secondary" id="prevStep">السابق</button>
        <button class="btn" id="nextStep">التالي</button>
        <button class="btn secondary" id="toggleAuto">إيقاف * تشغيل الأنيميشن</button>
        <button class="btn secondary" id="resetLesson">إعادة المحاكاة</button>
        <button class="btn secondary" id="colorCycle">تبديل لون الغرزة</button>
    </div>
      </div>
    </div>

    <!-- الشرح النظري المنسّق + الصور -->
    <div class="card">
      <div class="theory-header">الشرح النظري والبترون لي الدروس</div>
      <div class="theory-content">
        <div id="theoryText">اختر درسًا من القائمة لعرض البترون والتفاصيل الدقيقة.</div>
        <div class="pattern" id="patternBox">
          <div class="row" id="patternRow"></div>
          <div class="legend">
            
          </div>
        </div>

        <div class="gallery" id="gallery"></div>
      </div>
    </div>
  </div>

  <!-- عارض الصور -->
  <div class="modal" id="imgModal">
    <div class="modal-content">
      <img id="modalImg" src="" alt="عرض الصورة" />
    </div>
  </div>

  <!-- مكتبة Konva -->
  <script src="https://cdn.jsdelivr.net/npm/konva@9/konva.min.js"></script>
  <script>
    // صور توضيحية — ضع مسارات فعلية لي الصور بدل placeholders
    const placeholder = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600"><rect width="100%" height="100%" fill="#f1f1f1"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="24" fill="#999">صورة الدرس</text></svg>'
    );

    const lessons = [
      { id: 1, name: "سلسلة الأساس (Chain)", type: "chain", steps: 6,
      theory: "غرزة السلسلة هي الغرزة الأساسية في الكروشيه، وشكلها يشبه الضفيرة، وتُستخدم لتكوين أساس معظم المشاريع قبل بناء الغرز الأخرى فوقها.\nالاسم المكتوب: سلسلة، وتُختصر غالبًا إلى س أو ch في الباترون.\nالرمز المرسوم: شكل بيضاوي صغير أو حلقة صغيرة متتابعة تمثّل كل سلسلة على حدة.\nالخطوة الأولى: ابدئي بعقدة البداية على الخيط وثبّتيها على سن الإبرة.\nالخطوة الثانية: أمسكي الإبرة والخيط براحة، مع تثبيت شدّ الخيط باليد الأخرى.\nالخطوة الثالثة: لفّي الخيط على الإبرة من الخلف إلى الأمام.\nالخطوة الرابعة: اسحبي اللفة عبر الحلقة على الإبرة لتتكوّن أول سلسلة.\nالخطوة الخامسة: كرري الحركة للحصول على سلاسل إضافية.\nالخطوة السادسة: عدّي السلاسل بدقة، واحرصي أن تكون جميعها بشدّ متقارب.\nالخطوة السابعة: حافظي على شدّ ثابت لتفادي ضيق أو ارتخاء السلاسل.\nالخطوة الثامنة: تحقّقي من الطول المطلوب وتوقفي عند العدد المحدد في الباترون.\nالخطوة التاسعة: استعدّي للسطر الأول فوق السلاسل، مع إضافة سلاسل ارتفاع حسب الغرزة المستخدمة.\nالخطوة العاشرة: ابدئي الغرز فوق السلسلة بإدخال الإبرة في الحلقة المحددة وفق تعليمات الباترون.\nفي الباترون المرسوم: كل بيضاوي صغير يمثل سلسلة واحدة، ويُكتب العدد المطلوب بجانبه.\nفي الباترون المكتوب: تظهر بصيغة مثل س 12 أو ch 12 للدلالة على عدد السلاسل.\nالاستخدامات: تُستعمل السلسلة كأساس للمشاريع، لصنع حلقات، أو لتكوين مسافات زخرفية.\nالمعلومة السريعة: بعد إتقان السلسلة، يمكن استخدامها في مشاريع عديدة مثل الأوشحة والبطانيات، وهي أساس الكروشيه وتشبه الضفيرة في شكلها." ,
      pattern: [ "ابدئي بعقدة البداية على الخيط","ثبّتي العقدة على سن الإبرة","لفّي الخيط على الإبرة من الخلف إلى الأمام","اسحبي اللفة عبر الحلقة لتتكوّن سلسلة","كرري الحركة للحصول على العدد المطلوب من السلاسل"],
        images: ["1i.png", "2i.png", "3i.png"] },
      { id: 2, name: "غرزة منزلقة (Slip Stitch)", type: "slip", steps: 5,
      theory: "غرزة المنزلقة هي غرزة بسيطة في الكروشيه تُستخدم عادةً للوصل بين الغرز أو لإنهاء السطر بشكل مرتب، وتُعطي شكلاً مسطحًا دون ارتفاع.\nالاسم المكتوب: غرزة منزلقة، وتُختصر غالبًا إلى منز أو sl st في الباترون.\nالرمز المرسوم: نقطة صغيرة أو دائرة ممتلئة، وأحيانًا خط قصير مائل يرمز للغرزة المنزلقة.\nالخطوة الأولى: أدخلي الإبرة في الغرزة أو السلسلة المحددة حسب تعليمات الباترون.\nالخطوة الثانية: لفّي الخيط على الإبرة من الخلف إلى الأمام (لفة واحدة).\nالخطوة الثالثة: اسحبي اللفة عبر الغرزة التي دخلت فيها الإبرة.\nالخطوة الرابعة: اسحبي نفس اللفة مباشرة عبر الحلقة الموجودة على الإبرة، لتغلق الغرزة فورًا.\nالخطوة الخامسة: لا يتكوّن ارتفاع جديد؛ تبقى الغرزة مسطحة ومرتبطة بالغرزة السابقة.\nالاستخدامات: تُستعمل الغرزة المنزلقة للوصل بين نهايات الدوائر، لتثبيت الخيوط، أو للانتقال بين أجزاء العمل دون إضافة ارتفاع.\nفي الباترون المرسوم: تظهر كنقطة صغيرة أو دائرة ممتلئة، وتُستخدم عادةً في نهاية السطر أو بداية دائرة.\nفي الباترون المكتوب: تظهر بصيغة مثل منز أو sl st، وغالبًا مع عدد الغرز المطلوب.\nالمعلومة السريعة: الغرزة المنزلقة لا تُضيف ارتفاعًا، لكنها ضرورية لإنهاء الدوائر بشكل مرتب أو للانتقال بسلاسة بين الغرز.",
      pattern: [
  "أدخلي الإبرة في الغرزة المحددة",
  "لفّي الخيط على الإبرة",
  "اسحبي اللفة عبر الغرزة",
  "اسحبي نفس اللفة عبر الحلقة على الإبرة لإغلاق الغرزة"
],
        images: ["10i.png", "11i.png", "12i.png"] },
      { id: 3, name: "غرزة حشو (Single Crochet)", type: "sc", steps: 6,
      theory: "غرزة الحشو هي من أهم الغرز الأساسية في الكروشيه، وتُستخدم بكثرة في المشاريع لأنها تعطي نسيجًا متماسكًا وكثيفًا.\nالاسم المكتوب: غرزة الحشو، وتُختصر غالبًا إلى حش أو sc في الباترون.\nالرمز المرسوم: علامة تشبه حرف X صغير أو + في المخطط المرسوم.\nالخطوة الأولى: أدخلي الإبرة في الغرزة أو السلسلة المحددة حسب تعليمات الباترون.\nالخطوة الثانية: لفّي الخيط على الإبرة من الخلف إلى الأمام.\nالخطوة الثالثة: اسحبي اللفة عبر الغرزة، ليصبح لديك حلقتان على الإبرة.\nالخطوة الرابعة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة الخامسة: اسحبي اللفة عبر الحلقتين معًا لتغلق الغرزة.\nالخطوة السادسة: تتكوّن غرزة الحشو مكتملة، وتكون قصيرة وذات شكل متماسك.\nالاستخدامات: تُستعمل غرزة الحشو في البطانيات، الحقائب، الألعاب، وأي مشروع يحتاج إلى نسيج كثيف ومتين.\nفي الباترون المرسوم: تظهر كرمز X أو +، ويُكتب العدد المطلوب بجانبه.\nفي الباترون المكتوب: تظهر بصيغة مثل حش 10 أو sc 10 للدلالة على عدد الغرز.\nالمعلومة السريعة: غرزة الحشو سهلة التنفيذ، وتُعتبر أساسًا لتعلّم الغرز الأكثر تعقيدًا، كما أنها تمنح العمل شكلًا متماسكًا ومتينًا.",     
      pattern: [
  "أدخلي الإبرة في الغرزة المحددة",
  "لفّي الخيط على الإبرة",
  "اسحبي اللفة ليصبح لديك حلقتان",
  "لفّي الخيط مرة أخرى",
  "اسحبي اللفة عبر الحلقتين معًا لإكمال الغرزة"
],
        images: ["7i.png", "8i.png", "9i.png"] },
      { id: 4, name: "نصف عمود (Half Double Crochet)", type: "hdc", steps: 6,
      theory: "غرزة نصف العمود هي غرزة متوسطة الطول في الكروشيه، تجمع بين بساطة غرزة الحشو وارتفاع غرزة العمود، وتُعطي نسيجًا مرنًا ومتماسكًا.\nالاسم المكتوب: نصف عمود، وتُختصر غالبًا إلى نص أو hdc في الباترون.\nالرمز المرسوم: خط عمودي قصير يتوسطه خط صغير أو شرطة، يرمز إلى نصف العمود.\nالخطوة الأولى: لفّي الخيط على الإبرة مرة واحدة قبل إدخالها في الغرزة المحددة.\nالخطوة الثانية: أدخلي الإبرة في الغرزة أو السلسلة حسب تعليمات الباترون.\nالخطوة الثالثة: اسحبي اللفة عبر الغرزة، ليصبح لديك ثلاث حلقات على الإبرة.\nالخطوة الرابعة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة الخامسة: اسحبي اللفة عبر الحلقات الثلاث معًا دفعة واحدة.\nالخطوة السادسة: تتكوّن غرزة نصف العمود مكتملة، بطول متوسط بين الحشو والعمود.\nالاستخدامات: تُستعمل غرزة نصف العمود في البطانيات، الملابس، الحقائب، والمشاريع التي تحتاج نسيجًا مرنًا وغير كثيف جدًا.\nفي الباترون المرسوم: تظهر كخط عمودي قصير مع شرطة، ويُكتب العدد المطلوب بجانبه.\nفي الباترون المكتوب: تظهر بصيغة مثل نص 10 أو hdc 10 للدلالة على عدد الغرز.\nالمعلومة السريعة: غرزة نصف العمود سهلة التنفيذ، وتُعتبر خيارًا مثاليًا عند الرغبة في نسيج متوسط السماكة يجمع بين المرونة والمتانة.",
      pattern: [
  "لفّي الخيط على الإبرة مرة واحدة",
  "أدخلي الإبرة في الغرزة المحددة",
  "اسحبي اللفة ليصبح لديك ثلاث حلقات",
  "لفّي الخيط مرة أخرى",
  "اسحبي اللفة عبر الحلقات الثلاث معًا"
],
        images: ["4i.png", "5i.jpg", "6i.webp"] },
      { id: 5, name: "عمود بلفة (Double Crochet)", type: "dc", steps: 6,
      theory: "غرزة العمود بلفة هي من الغرز الأساسية في الكروشيه، وتتميز بطولها مقارنة بغرزة الحشو ونصف العمود، مما يمنح العمل مرونة وارتفاعًا أكبر.\nالاسم المكتوب: عمود بلفة، وتُختصر غالبًا إلى عم أو dc في الباترون.\nالرمز المرسوم: خط عمودي طويل يتوسطه خط صغير أو شرطة، يرمز إلى العمود بلفة.\nالخطوة الأولى: لفّي الخيط على الإبرة مرة واحدة قبل إدخالها في الغرزة المحددة.\nالخطوة الثانية: أدخلي الإبرة في الغرزة أو السلسلة حسب تعليمات الباترون.\nالخطوة الثالثة: اسحبي اللفة عبر الغرزة، ليصبح لديك ثلاث حلقات على الإبرة.\nالخطوة الرابعة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة الخامسة: اسحبي اللفة عبر أول حلقتين على الإبرة، ليبقى لديك حلقتان.\nالخطوة السادسة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة السابعة: اسحبي اللفة عبر الحلقتين المتبقيتين معًا لتغلق الغرزة.\nالخطوة الثامنة: تتكوّن غرزة العمود بلفة مكتملة، بطول أكبر من نصف العمود.\nالاستخدامات: تُستعمل غرزة العمود بلفة في البطانيات، الملابس، الشالات، والمشاريع التي تحتاج نسيجًا مرنًا وخفيفًا.\nفي الباترون المرسوم: تظهر كخط عمودي طويل مع شرطة، ويُكتب العدد المطلوب بجانبه.\nفي الباترون المكتوب: تظهر بصيغة مثل عم 10 أو dc 10 للدلالة على عدد الغرز.\nالمعلومة السريعة: غرزة العمود بلفة تمنح العمل ارتفاعًا ومرونة، وتُعتبر من أكثر الغرز شيوعًا في مشاريع الكروشيه.",
      pattern: [
  "لفّي الخيط على الإبرة مرة واحدة",
  "أدخلي الإبرة في الغرزة المحددة",
  "اسحبي اللفة ليصبح لديك ثلاث حلقات",
  "لفّي الخيط مرة أخرى",
  "اسحبي اللفة عبر حلقتين",
  "لفّي الخيط مرة أخرى",
  "اسحبي اللفة عبر الحلقتين المتبقيتين"
],
        images: ["13i.jfif", "14i.jfif", "15i.jfif"] },
      { id: 6, name: "عمود بلفتين (Treble)", type: "tr", steps: 6,
      theory: "غرزة العمود بلفتين هي غرزة أطول من العمود بلفة، وتُعطي ارتفاعًا أكبر ونسيجًا أكثر مرونة في الكروشيه.\nالاسم المكتوب: عمود بلفتين، وتُختصر غالبًا إلى عم2 أو tr في الباترون.\nالرمز المرسوم: خط عمودي طويل يتوسطه خطان صغيران أو شرطتان، يرمز إلى العمود بلفتين.\nالخطوة الأولى: لفّي الخيط على الإبرة مرتين قبل إدخالها في الغرزة المحددة.\nالخطوة الثانية: أدخلي الإبرة في الغرزة أو السلسلة حسب تعليمات الباترون.\nالخطوة الثالثة: اسحبي اللفة عبر الغرزة، ليصبح لديك أربع حلقات على الإبرة.\nالخطوة الرابعة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة الخامسة: اسحبي اللفة عبر أول حلقتين على الإبرة، ليبقى لديك ثلاث حلقات.\nالخطوة السادسة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة السابعة: اسحبي اللفة عبر حلقتين، ليبقى لديك حلقتان.\nالخطوة الثامنة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة التاسعة: اسحبي اللفة عبر الحلقتين المتبقيتين معًا لتغلق الغرزة.\nالخطوة العاشرة: تتكوّن غرزة العمود بلفتين مكتملة، بطول أكبر من العمود بلفة.\nالاستخدامات: تُستعمل غرزة العمود بلفتين في الشالات، المفارش، والقطع التي تحتاج إلى نسيج خفيف ومرتفع.\nفي الباترون المرسوم: تظهر كخط عمودي طويل مع شرطتين، ويُكتب العدد المطلوب بجانبه.\nفي الباترون المكتوب: تظهر بصيغة مثل عم2 10 أو tr 10 للدلالة على عدد الغرز.\nالمعلومة السريعة: غرزة العمود بلفتين تمنح العمل ارتفاعًا كبيرًا ومرونة، وتُستخدم لإضافة خفة وأناقة إلى المشاريع.",
      pattern: [
  "لفّي الخيط على الإبرة مرتين",
  "أدخلي الإبرة في الغرزة المحددة",
  "اسحبي اللفة ليصبح لديك أربع حلقات",
  "لفّي الخيط واسحبي عبر حلقتين",
  "لفّي الخيط واسحبي عبر حلقتين",
  "لفّي الخيط واسحبي عبر الحلقتين المتبقيتين"
],
        images: ["16i.jfif", "17i.jfif", "18i.jfif"] },
      { id: 7, name: "غرزة V", type: "v", steps: 5,
      theory: "غرزة V هي غرزة زخرفية في الكروشيه، تُعطي شكلًا يشبه حرف V، وتُستخدم لإضافة فراغات ونقوش جميلة في المشاريع.\nالاسم المكتوب: غرزة V، وتُختصر غالبًا إلى V st في الباترون.\nالرمز المرسوم: حرف V صغير يتكون من عمودين متجاورين مع سلسلة بينهما.\nالخطوة الأولى: ابدئي بعمل سلسلة الأساس حسب تعليمات الباترون.\nالخطوة الثانية: لفّي الخيط على الإبرة مرة واحدة.\nالخطوة الثالثة: أدخلي الإبرة في الغرزة أو السلسلة المحددة.\nالخطوة الرابعة: اسحبي اللفة عبر الغرزة ليصبح لديك ثلاث حلقات على الإبرة.\nالخطوة الخامسة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة السادسة: اسحبي اللفة عبر أول حلقتين، ليبقى لديك حلقتان.\nالخطوة السابعة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة الثامنة: اسحبي اللفة عبر الحلقتين المتبقيتين لتغلق أول عمود.\nالخطوة التاسعة: اعملي سلسلة واحدة (ch 1) لتكوين الفراغ داخل الغرزة.\nالخطوة العاشرة: كرري غرزة عمود بلفة أخرى في نفس المكان لتشكيل حرف V.\nالاستخدامات: تُستعمل غرزة V في الشالات، المفارش، والقطع الزخرفية التي تحتاج إلى فراغات أنيقة.\nفي الباترون المرسوم: تظهر كحرف V مكوّن من عمودين مع سلسلة بينهما.\nفي الباترون المكتوب: تظهر بصيغة مثل (عم، سلسلة، عم) أو (dc, ch 1, dc) في نفس الغرزة.\nالمعلومة السريعة: غرزة V سهلة التنفيذ وتُضيف لمسة زخرفية جميلة، كما أنها تُستخدم كثيرًا في التصاميم المفتوحة والخفيفة.",
      pattern: [
  "اعملي عمود غير مكتمل في الغرزة المحددة",
  "كرري نفس الخطوة لعدد معين من الأعمدة (3 أو 4)",
  "لفّي الخيط على الإبرة",
  "اسحبي الخيط عبر جميع الحلقات دفعة واحدة لإغلاق العنقود"
],
        images: ["19i.jfif", "20i.jfif", "21i.jfif"] },
      { id: 8, name: "عنقودية (Cluster)", type: "cluster", steps: 5,
      theory: "غرزة العنقودية هي غرزة زخرفية في الكروشيه تُنفذ بجمع عدة غرز غير مكتملة في نفس المكان ثم إغلاقها معًا، مما يعطي شكلًا متماسكًا يشبه العنقود.\nالاسم المكتوب: غرزة عنقودية، وتُختصر غالبًا إلى عنق أو cl في الباترون.\nالرمز المرسوم: مجموعة من الأعمدة متجاورة تتجمع في الأعلى بخط واحد، يرمز إلى الغرزة العنقودية.\nالخطوة الأولى: لفّي الخيط على الإبرة حسب نوع الغرزة (عادةً عمود بلفة).\nالخطوة الثانية: أدخلي الإبرة في الغرزة أو السلسلة المحددة.\nالخطوة الثالثة: اسحبي اللفة عبر الغرزة ليصبح لديك ثلاث حلقات على الإبرة.\nالخطوة الرابعة: اسحبي الخيط عبر أول حلقتين فقط، واتركي باقي الحلقات على الإبرة.\nالخطوة الخامسة: كرري نفس الخطوات في نفس المكان لعدد معين من الأعمدة غير المكتملة (مثلاً 3 أو 4).\nالخطوة السادسة: بعد تكوين عدة أعمدة غير مكتملة، لفّي الخيط على الإبرة.\nالخطوة السابعة: اسحبي الخيط عبر جميع الحلقات الموجودة على الإبرة دفعة واحدة لإغلاق العنقود.\nالاستخدامات: تُستعمل غرزة العنقودية في المفارش، البطانيات، الشالات، والقطع الزخرفية لإضافة ملمس بارز وجمالي.\nفي الباترون المرسوم: تظهر كمجموعة أعمدة متجاورة تتجمع في الأعلى.\nفي الباترون المكتوب: تظهر بصيغة مثل (عنق من 3 أعمدة) أو (cl of 3 dc).\nالمعلومة السريعة: غرزة العنقودية تُضيف بروزًا وأناقة إلى العمل، وتُعتبر من الغرز الزخرفية المميزة التي تمنح القطعة شكلًا غنيًا ومزخرفًا.",
      pattern: [
  "اعملي عمود غير مكتمل في الغرزة المحددة",
  "كرري نفس الخطوة لعدد معين من الأعمدة (3 أو 4)",
  "لفّي الخيط على الإبرة",
  "اسحبي الخيط عبر جميع الحلقات دفعة واحدة لإغلاق العنقود"
],
        images: ["22i.jfif", "23i.jfif", "24i.jfif"] },
      { id: 9, name: "بوب كورن (Popcorn)", type: "popcorn", steps: 5,
      theory: "غرزة البوب كورن هي غرزة زخرفية بارزة في الكروشيه، تُعطي شكلًا ثلاثي الأبعاد يشبه حبة الفشار، وتُستخدم لإضافة ملمس جميل ومميز للمشاريع.\nالاسم المكتوب: غرزة بوب كورن، وتُختصر غالبًا إلى بوب أو pc في الباترون.\nالرمز المرسوم: دائرة صغيرة ممتلئة أو شكل يشبه حبة بارزة، يرمز إلى غرزة البوب كورن.\nالخطوة الأولى: اعملي عدة غرز عمود بلفة (عادةً 5) في نفس الغرزة أو السلسلة المحددة.\nالخطوة الثانية: اسحبي الإبرة من الغرزة الأخيرة وأخرجيها قليلًا لتوسيع الحلقة.\nالخطوة الثالثة: أعيدي إدخال الإبرة في أول غرزة عمود من المجموعة.\nالخطوة الرابعة: التقطي الحلقة التي تركتها واسحبيها عبر أول غرزة عمود لتغلق المجموعة معًا.\nالخطوة الخامسة: تتكوّن غرزة البوب كورن بارزة وذات شكل ثلاثي الأبعاد.\nالاستخدامات: تُستعمل غرزة البوب كورن في البطانيات، المفارش، الحقائب، والقطع الزخرفية لإضافة بروز وملمس مميز.\nفي الباترون المرسوم: تظهر كدائرة صغيرة ممتلئة أو رمز بارز.\nفي الباترون المكتوب: تظهر بصيغة مثل (بوب من 5 أعمدة) أو (pc of 5 dc).\nالمعلومة السريعة: غرزة البوب كورن تُضيف لمسة زخرفية بارزة وجذابة، وتُعتبر من الغرز المميزة التي تمنح العمل شكلًا غنيًا وملمسًا ثلاثي الأبعاد.",
      pattern: [
  "اعملي 5 أعمدة بلفة في نفس الغرزة",
  "اسحبي الإبرة من آخر غرزة وأخرجيها قليلًا",
  "أدخلي الإبرة في أول عمود من المجموعة",
  "التقطي الحلقة الأخيرة واسحبيها عبر أول عمود لإغلاق المجموعة"
],
        images: ["25i.jfif", "26i.jfif", "27i.jfif"] },
      { id: 10, name: "حبية (Bobble)", type: "bobble", steps: 5,
      theory: "غرزة الحبية هي غرزة زخرفية بارزة في الكروشيه، تُعطي شكلًا دائريًا صغيرًا يشبه الحبة أو الكرة، وتُستخدم لإضافة ملمس جميل ومميز للمشاريع.\nالاسم المكتوب: غرزة الحبية، وتُختصر غالبًا إلى حب أو bo في الباترون.\nالرمز المرسوم: دائرة صغيرة أو شكل بارز يشير إلى الغرزة الحبية.\nالخطوة الأولى: لفّي الخيط على الإبرة واعملي غرزة عمود غير مكتملة في الغرزة المحددة.\nالخطوة الثانية: اتركي آخر لفة على الإبرة دون إكمالها.\nالخطوة الثالثة: كرري نفس الخطوة عدة مرات (عادةً 4 أو 5 أعمدة غير مكتملة) في نفس المكان، ليصبح لديك عدة حلقات على الإبرة.\nالخطوة الرابعة: لفّي الخيط مرة أخرى على الإبرة.\nالخطوة الخامسة: اسحبي الخيط عبر جميع الحلقات الموجودة على الإبرة دفعة واحدة لإغلاق الغرزة.\nالخطوة السادسة: تتكوّن غرزة الحبية بارزة وذات شكل دائري صغير.\nالاستخدامات: تُستعمل غرزة الحبية في البطانيات، المفارش، الحقائب، والقطع الزخرفية لإضافة بروز وملمس مميز.\nفي الباترون المرسوم: تظهر كدائرة صغيرة أو رمز بارز.\nفي الباترون المكتوب: تظهر بصيغة مثل (حب من 5 أعمدة) أو (bo of 5 dc).\nالمعلومة السريعة: غرزة الحبية تُضيف لمسة زخرفية بارزة وجذابة، وتُعتبر من الغرز المميزة التي تمنح العمل شكلًا غنيًا وملمسًا ثلاثي الأبعاد.",
      pattern: [
  "اعملي عمود غير مكتمل في الغرزة المحددة",
  "كرري نفس الخطوة 4 أو 5 مرات في نفس المكان",
  "لفّي الخيط على الإبرة",
  "اسحبي الخيط عبر جميع الحلقات دفعة واحدة لإغلاق الغرزة"
],
        images: ["28i.jfif", "29i.jfif", "30i.jfif"] },
      { id: 11, name: "قشرة (Shell)", type: "shell", steps: 5,
      theory: "غرزة القشرة هي غرزة زخرفية في الكروشيه تُعطي شكلًا يشبه القشرة أو المروحة، وتُستخدم لإضافة لمسة جمالية وانسيابية للمشاريع.\nالاسم المكتوب: غرزة القشرة، وتُختصر غالبًا إلى قش أو shell st في الباترون.\nالرمز المرسوم: مجموعة من الأعمدة متجاورة في نفس الغرزة أو السلسلة، تُرسم عادةً بشكل نصف دائرة أو مروحة.\nالخطوة الأولى: ابدئي بعمل سلسلة الأساس حسب تعليمات الباترون.\nالخطوة الثانية: حددي الغرزة أو السلسلة التي ستنفذين فيها غرزة القشرة.\nالخطوة الثالثة: لفّي الخيط على الإبرة واعملي عدة غرز عمود بلفة (عادةً 5) في نفس الغرزة أو السلسلة.\nالخطوة الرابعة: بعد الانتهاء من الأعمدة، ينتج شكل نصف دائرة يشبه القشرة.\nالخطوة الخامسة: اتركي عددًا محددًا من الغرز فارغة حسب الباترون، ثم كرري غرزة القشرة في الغرزة التالية.\nالاستخدامات: تُستعمل غرزة القشرة في المفارش، البطانيات، الشالات، والقطع الزخرفية لإضافة شكل مروحي جميل.\nفي الباترون المرسوم: تظهر كمجموعة أعمدة متجاورة على شكل نصف دائرة.\nفي الباترون المكتوب: تظهر بصيغة مثل (5 عم في نفس الغرزة) أو (5 dc in same st).\nالمعلومة السريعة: غرزة القشرة سهلة التنفيذ وتُضيف لمسة زخرفية أنيقة، وتُعتبر من الغرز الشائعة في التصاميم الزخرفية.",
      pattern: [
  "اعملي 5 أعمدة بلفة في نفس الغرزة",
  "اتركي عددًا من الغرز فارغة حسب الباترون",
  "كرري نفس مجموعة الأعمدة في الغرزة التالية"
],
        images: ["31i.jfif", "32i.jfif", "33i.jfif"] },
      { id: 12, name: "حلقة أمامية/خلفية (Front/Back Loop)", type: "loops", steps: 6,
      theory: "غرزة الحلقة الأمامية/الخلفية هي طريقة خاصة في الكروشيه تُنفذ بإدخال الإبرة في جزء محدد من السلسلة أو الغرزة، إما الحلقة الأمامية أو الحلقة الخلفية، مما يعطي تأثيرًا زخرفيًا مختلفًا للنسيج.\nالاسم المكتوب: غرزة الحلقة الأمامية/الخلفية، وتُختصر غالبًا إلى حل أمامية (FLO) أو حل خلفية (BLO) في الباترون.\nالرمز المرسوم: يُشار إليها عادةً بخط صغير على الحلقة الأمامية أو الخلفية للغرزة في المخطط.\nالخطوة الأولى: حددي الغرزة التي ستعملين فيها.\nالخطوة الثانية: لإدخال الإبرة في الحلقة الأمامية، أدخليها فقط في الجزء الأمامي من الغرزة (الحلقة الأقرب إليك).\nالخطوة الثالثة: لإدخال الإبرة في الحلقة الخلفية، أدخليها فقط في الجزء الخلفي من الغرزة (الحلقة الأبعد عنك).\nالخطوة الرابعة: نفذي الغرزة المطلوبة (حشو، نصف عمود، عمود...) في الحلقة المحددة.\nالخطوة الخامسة: كرري العملية في الغرز التالية حسب تعليمات الباترون.\nالاستخدامات: تُستعمل غرزة الحلقة الأمامية/الخلفية لإضافة خطوط بارزة أو زخارف مميزة، كما تُستخدم في تصميم الأقمشة المرنة أو لإبراز نقوش محددة.\nفي الباترون المرسوم: تظهر بخط صغير يحدد الحلقة الأمامية أو الخلفية.\nفي الباترون المكتوب: تظهر بصيغة مثل حش في BLO أو عم في FLO.\nالمعلومة السريعة: العمل في الحلقة الأمامية يعطي تأثيرًا زخرفيًا بارزًا، بينما العمل في الحلقة الخلفية يُظهر خطًا أفقيًا جميلًا على النسيج.",
      pattern: [
  "لتنفيذ الحلقة الأمامية: أدخلي الإبرة في الحلقة الأمامية فقط",
  "لتنفيذ الحلقة الخلفية: أدخلي الإبرة في الحلقة الخلفية فقط",
  "اعملي الغرزة المطلوبة (حشو، عمود...) في الحلقة المحددة"
],
        images: ["34i.jfif", "35i.jfif", "36i.jfif"] },
    ];

    // حالة التطبيق
    let currentLessonIndex = 0;
    let currentStep = 1;
    let autoAnimationOn = true;
    let isSidebarCollapsed = false;

    // Konva setup
    const stage = new Konva.Stage({
      container: 'stage-container',
      width: 820,
      height: 420
    });
    const layer = new Konva.Layer();
    stage.add(layer);

    // عناصر الرسم: خيط، غرزة، إبرة (Polygon) + ظل
    const yarnPath = new Konva.Line({
  points: [],
  stroke: getComputedStyle(document.documentElement).getPropertyValue('--yarn-color').trim(),
  strokeWidth: 4,
  lineCap: 'round',
  lineJoin: 'round',
  tension: 0.4,
  shadowColor: 'rgba(0,0,0,0.3)',
  shadowBlur: 4,
  shadowOffset: { x: 2, y: 2 },
  shadowOpacity: 0.5
});


    const stitchShape = new Konva.Shape({
      sceneFunc: function(ctx, shape) {
        ctx.beginPath();
        ctx.ellipse(stage.width()/2, stage.height()/2, 60, 36, 0, 0, Math.PI*2);
        ctx.fillStyle = shape.fill();
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#333';
        ctx.stroke();
      },
      fill: getComputedStyle(document.documentElement).getPropertyValue('--stitch-color').trim(),
      draggable: true,
      shadowColor: 'rgba(0,0,0,0.2)',
      shadowBlur: 10,
      shadowOffset: { x: 0, y: 4 },
      shadowOpacity: 0.6
    });

    // إبرة كمضلع مع رأس مدبّب وظل
    const needleGroup = new Konva.Group({ x: stage.width()/2 - 140, y: stage.height()/2 - 20 });
    const needleBody = new Konva.Line({
      points: [0,0, 90,0],
      stroke: '#aaa',
      strokeWidth: 6,
      lineCap: 'round',
      shadowColor: 'rgba(0,0,0,0.15)',
      shadowBlur: 8,
      shadowOffset: { x: 2, y: 3 },
      shadowOpacity: 0.7
    });
    const needleTipPoly = new Konva.Line({
      points: [86,-6, 96,0, 86,6], // مثلث صغير كرأس الإبرة
      fill: '#c33',
      closed: true,
      stroke: '#333',
      strokeWidth: 1,
      shadowColor: 'rgba(0,0,0,0.15)',
      shadowBlur: 6,
      shadowOffset: { x: 1, y: 2 },
      shadowOpacity: 0.6
    });
    needleGroup.add(needleBody);
    needleGroup.add(needleTipPoly);

    // ظل الغرزة
    const glow = new Konva.Ellipse({
      x: stage.width()/2, y: stage.height()/2 + 48, radiusX: 64, radiusY: 12,
      fill: 'rgba(0,0,0,0.08)'
    });

    layer.add(glow);
    layer.add(yarnPath);
    layer.add(stitchShape);
    layer.add(needleGroup);
    layer.draw();

    // أنيميشن تلقائي: اهتزاز/تنفس
    const wobble = new Konva.Animation((frame) => {
      if (!autoAnimationOn) return;
      const t = frame.time / 1000;
      const angle = Math.sin(t * 2) * 4;
      stitchShape.rotation(angle);
      const scale = 1 + Math.sin(t * 1.2) * 0.02;
      stitchShape.scale({ x: scale, y: scale });
      glow.scale({ x: scale * 1.02, y: 1 });
    }, layer);
    wobble.start();

    // تفاعل اللون
    const colors = ['#ff9060', '#92d36e', '#a989e8', '#56cfe1', '#ffd166'];
    document.getElementById('colorCycle').addEventListener('click', () => {
      const current = stitchShape.fill();
      const idx = colors.indexOf(current);
      const next = colors[(idx + 1 + colors.length) % colors.length];
      stitchShape.fill(next);
      document.documentElement.style.setProperty('--stitch-color', next);
      layer.batchDraw();
    });
    stitchShape.on('click', () => {
      document.getElementById('colorCycle').click();
    });

    // جذب تفاعلي: سحب الغرزة يجذب الإبرة والخيط نحوها
    stitchShape.on('dragmove', () => {
      const pos = stitchShape.position();
      const targetX = pos.x - 80;
      const targetY = pos.y - 12;
      new Konva.Tween({
        node: needleGroup,
        x: targetX, y: targetY,
        rotation: angleTo(needleGroup.x(), needleGroup.y(), pos.x, pos.y),
        duration: 0.2,
        easing: Konva.Easings.EaseInOut
      }).play();

      // مسار الخيط بين نقطة مرجعية والغرزة
      const anchorX = stage.width()/2 - 220;
      const anchorY = stage.height()/2 + 60;
      const curve = bezierBetween(anchorX, anchorY, pos.x, pos.y);
      yarnPath.points(curve);
      layer.batchDraw();
    });

    // أدوات مساعدة
    function angleTo(x1, y1, x2, y2) {
      const a = Math.atan2(y2 - y1, x2 - x1);
      return a * 180 / Math.PI;
    }
    function bezierBetween(ax, ay, bx, by) {
      const cx = (ax + bx) / 2;
      const cy = Math.min(ay, by) - 60;
      return [ax, ay, cx, cy, bx, by]; // نقاط Bezier مبسطة (Konva.Line مع tension يعطي سلاسة)
    }
    function tweenNeedleTo(x, y, rot = 0, dur = 0.4) {
      new Konva.Tween({ node: needleGroup, x, y, rotation: rot, duration: dur, easing: Konva.Easings.EaseInOut }).play();
    }
    function drawPointsSmooth(points) {
      yarnPath.points(points);
      layer.batchDraw();
    }

    // محاكاة حسب نوع الغرزة
    function simulate(lessonType, step) {
      // ضبط اللون الحالي للخيط من :root
      yarnPath.stroke(getComputedStyle(document.documentElement).getPropertyValue('--yarn-color').trim());

      // إعادة الضبط
      yarnPath.points([]);
      needleGroup.position({ x: stage.width()/2 - 140, y: stage.height()/2 - 20 });
      needleGroup.rotation(0);

      switch (lessonType) {
        case 'chain': return simulateChain(step);
        case 'slip': return simulateSlip(step);
        case 'sc': return simulateSingle(step);
        case 'hdc': return simulateHalfDouble(step);
        case 'dc': return simulateDouble(step);
        case 'tr': return simulateTreble(step);
        case 'v': return simulateV(step);
        case 'cluster': return simulateCluster(step);
        case 'popcorn': return simulatePopcorn(step);
        case 'bobble': return simulateBobble(step);
        case 'shell': return simulateShell(step);
        case 'loops': return simulateLoops(step);
        default: return simulateChain(step);
      }
    }

    // دوال المحاكاة مع جذب وحركة دقيقة للإبرة والخيط
    function simulateChain(step) {
      const baseX = stage.width()/2 - 200;
      const y = stage.height()/2 + 30;
      const spacing = 48;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const cx = baseX + i * spacing;
        pts.push(cx, y, cx + 16, y - 8, cx + 32, y, cx + 16, y + 8);
      }
      drawPointsSmooth(pts);
      const nx = baseX + (step - 1) * spacing + 6;
      tweenNeedleTo(nx - 16, y - 18, -18);
    }

    function simulateSlip(step) {
      const baseX = stage.width()/2 - 160;
      const y = stage.height()/2 + 16;
      const spacing = 54;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const cx = baseX + i * spacing;
        pts.push(cx, y, cx + 22, y + 2, cx + 44, y);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(baseX + (step - 1) * spacing, y - 10, -8);
    }

    function simulateSingle(step) {
      const baseX = stage.width()/2 - 160;
      const baseY = stage.height()/2 + 10;
      const spacing = 56;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const x = baseX + i * spacing;
        pts.push(x, baseY, x + 18, baseY - 18, x + 36, baseY);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(baseX + (step - 1) * spacing + 10, baseY - 24, -22);
    }

    function simulateHalfDouble(step) {
      const baseX = stage.width()/2 - 160;
      const y = stage.height()/2;
      const spacing = 60;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const x = baseX + i * spacing;
        pts.push(x, y, x + 20, y - 26, x + 40, y);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(baseX + (step - 1) * spacing + 12, y - 30, -28);
    }

    function simulateDouble(step) {
      const baseX = stage.width()/2 - 160;
      const y = stage.height()/2 - 6;
      const spacing = 64;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const x = baseX + i * spacing;
        pts.push(x, y + 10, x + 20, y - 34, x + 40, y + 10);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(baseX + (step - 1) * spacing + 16, y - 36, -30);
    }

    function simulateTreble(step) {
      const baseX = stage.width()/2 - 160;
      const y = stage.height()/2 - 16;
      const spacing = 68;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const x = baseX + i * spacing;
        pts.push(x, y + 14, x + 22, y - 42, x + 44, y + 14);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(baseX + (step - 1) * spacing + 18, y - 44, -32);
    }

    function simulateV(step) {
      const cx = stage.width()/2;
      const y = stage.height()/2;
      const spread = 26 + step * 2;
      const pts = [cx - spread, y, cx, y - 34, cx + spread, y];
      drawPointsSmooth(pts);
      tweenNeedleTo(cx, y - 24, 0);
    }

    function simulateCluster(step) {
      const cx = stage.width()/2;
      const y = stage.height()/2;
      const arms = Math.min(3 + step, 6);
      const pts = [];
      for (let i = 0; i < arms; i++) {
        const dx = (i - arms/2) * 18;
        pts.push(cx + dx, y + 6, cx + dx + 12, y - 24, cx + dx + 24, y + 6);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(cx + 8, y - 18, -16);
    }

    function simulatePopcorn(step) {
      const cx = stage.width()/2;
      const y = stage.height()/2 - 10;
      const columns = Math.min(4 + (step - 1), 6);
      const pts = [];
      for (let i = 0; i < columns; i++) {
        const dx = (i - columns/2) * 16;
        pts.push(cx + dx, y + 20, cx + dx + 8, y - 32, cx + dx + 16, y + 20);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(cx + 6, y - 12, -12);
    }

    function simulateBobble(step) {
      const cx = stage.width()/2;
      const y = stage.height()/2 - 6;
      const n = Math.min(3 + step, 6);
      const pts = [];
      for (let i = 0; i < n; i++) {
        const dx = (i - n/2) * 15;
        pts.push(cx + dx, y + 16, cx + dx + 10, y - 28, cx + dx + 20, y + 16);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(cx, y - 18, -18);
    }

    function simulateShell(step) {
      const cx = stage.width()/2;
      const y = stage.height()/2 + 10;
      const n = Math.min(3 + step, 7);
      const pts = [];
      for (let i = 0; i < n; i++) {
        const angle = -Math.PI/3 + (i * (Math.PI/3) / (n - 1));
        const r = 70;
        const x = cx + r * Math.cos(angle);
        const yy = y + r * Math.sin(angle);
        pts.push(x - 12, yy + 10, x, yy - 20, x + 12, yy + 10);
      }
      drawPointsSmooth(pts);
      tweenNeedleTo(cx, y - 26, 0);
    }

    function simulateLoops(step) {
      const baseX = stage.width()/2 - 160;
      const y = stage.height()/2 + 8;
      const spacing = 52;
      const pts = [];
      for (let i = 0; i < step; i++) {
        const x = baseX + i * spacing;
        const isFront = i % 2 === 0;
        const dy = isFront ? -18 : -8;
        pts.push(x, y, x + 18, y + dy, x + 36, y);
      }
      drawPointsSmooth(pts);
      const x = baseX + (step - 1) * spacing + 12;
      const rot = step % 2 === 0 ? -14 : -26;
      tweenNeedleTo(x, y - 18, rot);
    }

    // مزج اللون والأسلوب بدقة لكل نوع
    function stylizeStitchForType(type) {
      const map = {
        chain: '#56cfe1', slip: '#ffd166', sc: '#ff9060', hdc: '#f77f00',
        dc: '#e36414', tr: '#c44536', v: '#92d36e', cluster: '#a989e8',
        popcorn: '#f9c74f', bobble: '#ef476f', shell: '#43aa8b', loops: '#577590'
      };
      const fill = map[type] || getComputedStyle(document.documentElement).getPropertyValue('--stitch-color').trim();
      stitchShape.fill(fill);
      document.documentElement.style.setProperty('--stitch-color', fill);

      stitchShape.sceneFunc(function(ctx, shape) {
        ctx.beginPath();
        const w = type === 'tr' || type === 'dc' ? 72 : 60;
        const h = type === 'shell' ? 42 : 36;
        ctx.ellipse(stage.width()/2, stage.height()/2, w, h, 0, 0, Math.PI*2);
        ctx.fillStyle = shape.fill();
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#333';
        ctx.stroke();
      });
      layer.batchDraw();
    }

    // واجهة المستخدم: بناء القائمة، العرض، الصور
    function buildLessonsList() {
      const list = document.getElementById('lessonsList');
      list.innerHTML = '';
      lessons.forEach((lesson, i) => {
        const item = document.createElement('div');
        item.className = 'lesson-item';
        item.innerHTML = `
          <div>
            <div class="lesson-name">${lesson.name}</div>
            <div class="lesson-meta">${lesson.steps} خطوات · محاكاة واقعية للإبرة</div>
          </div>
          <div style="font-size:12px;color:#888">▶</div>
        `;
        item.addEventListener('click', () => renderLesson(i));
        list.appendChild(item);
      });
    }

    function renderGallery(images) {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      images.forEach(src => {
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        const img = document.createElement('img');
        img.src = src || placeholder;
        img.alt = 'صورة توضيحية';
        thumb.appendChild(img);
        thumb.addEventListener('click', () => openModal(img.src));
        gallery.appendChild(thumb);
      });
    }

    function openModal(src) {
      const modal = document.getElementById('imgModal');
      const img = document.getElementById('modalImg');
      img.src = src;
      modal.classList.add('open');
    }
    document.getElementById('imgModal').addEventListener('click', () => {
      document.getElementById('imgModal').classList.remove('open');
    });

    function renderLesson(idx) {
      currentLessonIndex = idx;
      currentStep = 1;
      const lesson = lessons[idx];
      document.getElementById('lessonTitle').textContent = lesson.name;
      document.getElementById('stepIndicator').textContent = `الخطوة ${currentStep} من ${lesson.steps}`;
      document.getElementById('theoryText').textContent = lesson.theory;

      const row = document.getElementById('patternRow');
      row.innerHTML = '';
      lesson.pattern.forEach((token) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = token;
        row.appendChild(chip);
      });

      renderGallery(lesson.images || []);
      stylizeStitchForType(lesson.type);
      simulate(lesson.type, currentStep);

      document.querySelectorAll('.lesson-item').forEach((el, i) => {
        el.classList.toggle('active', i === idx);
      });
    }

    // أزرار التحكم
    document.getElementById('nextStep').addEventListener('click', () => {
      const lesson = lessons[currentLessonIndex];
      if (currentStep < lesson.steps) {
        currentStep++;
        simulate(lesson.type, currentStep);
        document.getElementById('stepIndicator').textContent = `الخطوة ${currentStep} من ${lesson.steps}`;
      }
    });
    document.getElementById('prevStep').addEventListener('click', () => {
      const lesson = lessons[currentLessonIndex];
      if (currentStep > 1) {
        currentStep--;
        simulate(lesson.type, currentStep);
        document.getElementById('stepIndicator').textContent = `الخطوة ${currentStep} من ${lesson.steps}`;
      }
    });
    document.getElementById('toggleAuto').addEventListener('click', () => {
      autoAnimationOn = !autoAnimationOn;
    });
    document.getElementById('resetLesson').addEventListener('click', () => {
      renderLesson(currentLessonIndex);
    });

    // إخفاء/إظهار القائمة وتوسيع الشرح النظري
    document.getElementById('toggleSidebar').addEventListener('click', () => {
      isSidebarCollapsed = !isSidebarCollapsed;
      document.body.classList.toggle('collapsed', isSidebarCollapsed);
      document.getElementById('sidebarCard').style.display = isSidebarCollapsed ? 'none' : 'block';
    });

    // اختيارات الألوان (خيط/غرزة)
    document.getElementById('yarnColorPicker').addEventListener('input', (e) => {
      document.documentElement.style.setProperty('--yarn-color', e.target.value);
      yarnPath.stroke(e.target.value);
      layer.batchDraw();
    });
    document.getElementById('stitchColorPicker').addEventListener('input', (e) => {
      document.documentElement.style.setProperty('--stitch-color', e.target.value);
      stitchShape.fill(e.target.value);
      layer.batchDraw();
    });

    // بدء التشغيل
    buildLessonsList();
    renderLesson(0);
  </script>
</body>
</html>